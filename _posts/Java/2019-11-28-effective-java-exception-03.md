---
layout: post
title: "Java中避免不必要地使用受检查异常"
date: 2019-11-28 08:38:00
categories: Java 
tags: Effective-Java Java-Coding
---

* content
{:toc}

受检查异常如果使用得当，可以改善API和程序，不同于返回码和未受检查异常，受检查异常强迫方法调用者必须处理异常，以增加程序的可靠性。但是过度的使用受检查异常会是API使用起来非常不方便: 方法抛出受检查异常，调用该方法的代码就必须在一个或者多个catch块中处理这些异常或者声明抛出这些异常，并让其传播出去。无论哪种方法都会增加不可忽视的负担(`在Java1.8中，由于抛出受检查异常的方法不能直接在Stream中使用`)

如果`正确地使用API并不能阻止这种异常条件的产生`，并且一旦产生异常，`使用API的调用者立即采取有用的动作`，这种负担被认为是正当的。除非这两个条件都成立，否则更适合使用未受检查的异常



- Optional容器类型代替受检查异常

消除受检查异常最容易的办法是返回所要结果类型的一个Optional，这个方法不抛出受检查异常，而只是返回一个空的Optional。当然这种方法也有缺点: 方法无法返回任何额外的信息来详细说明它无法执行的原因，相反异常则具有描述性，并对外提供额外的信息

- boolean返回值代替是否应该抛出异常

`把受检查异常变成为未受检查异常`的另一种方法是，把这个抛出异常的方法分成两个方法: 其中一个方法返回一个boolean值，表明是否应该抛出异常; 另一个方法则抛出受检查异常。

```java

try{
	obj.action(args)
}catch(CheckedException e){
	//handler exception
}

if(obj.actionPermitted(args)){
	obj.action(args);
}else{
	//xxxx
}
```

当然这种重构并非恰当，但是凡是在恰当的地方它都会使API用起来更加舒服: 虽然后者的调用序列没有前者简单，但是这使得API更加灵活。如果API的使用者知道调用将会成功或者不介意由于调用失败而导致的线程终止，这种重构还允许使用更为简单的调用形式: 

```java
obj.action(args);
```

如果怀疑简单的调用序列不符合要求，这个API重构可能就是值得的，重构后的API本质上等同于`状态测试方法`。但是如果对象将在缺少外部同步的情况下被并发访问或者可被外界改变状态，这种重构就是不恰当的: 在两个方法调用的时间间隔之中，对象的状态可能会发生变化。如单独的`状态测试方法`必须重复action方法的工作，处于性能的考虑，这种API重构就不值得去做


总结: 在谨慎使用的前提下，受检查异常可以提升程序的可读性；如果过度使用，将会使API使用起来非常痛苦。如果调用者无法恢复失败，就应该抛出未受检查异常。如果可以恢复，并且想要迫使调用者处理异常的条件，首选应该返回一个Optinal值。当前仅当万一失败时，这些无法提供足够的信息，才应该抛出受检查异常




