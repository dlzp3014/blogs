---
layout: post
title:  "JVM中对象头和锁"
date:   2019-08-22 08:38:00
categories: Java 
tags: Java JVM
---

* content
{:toc}


`在JVM的实现中每个对象都有一个对象头，用于保存对象的系统信息`。对象头中有一个称为`Mark Word`的部分，它是实现锁的关键。在32位系统中，Mark Word为一个32为的数据，在64为系统中，它占64为。Mark Word是一个多功能的数据区，可以存储对象的`哈希值、对象的年龄、锁的指针`等信息。一个对象是否占有锁，占有哪个锁【具体查看[JVM中锁的实现和优化](/2019/08/12/java-jvm-concurrent-lock/)】，都记录在这个Mark Word中。





以32位系统为例，普通对象的对象头如下所示：

```java
hash:25  | age:4 biased_lock:1 lock:2
```
表示Mark Word中25位比特表示对象的哈希值、4为比特表示对象的年龄、1为比特是否为偏向锁、2为比特为锁的信息


对于`偏向锁`的对象，它的格式如下：

```java
[javathread* | epoch | age | 1 |01]

```

前23为表示持有偏向锁的线程，后续2为比特表示偏向锁的时间戳(epoch)、4为比特表示对象的年龄、年龄后的比特固定为1、表示偏向锁、最后2个为01表示可偏向/未锁定

当对象处于`轻量级锁`定时，其Mark Word如下(00表示最后2为的值)：

```java

[ptr    | 00] locked
```

此时,它指向存放在获得锁的线程栈中该对象真实对象头。

当对象处于`重量级锁`定时，其Mark Word如下：

```java
[ptr    | 00] monitor
```

此时，最后2为10，整个Mark Word表示指向Monitor的指针

当对象处于普通的`未锁定`状态时，其格式如下：

```java
[header |0 | 01] unlocked
```

前29为表示对象的哈希值，年龄等信息。倒数第3为0，最后两位为01，表示未锁定。可以发现最后两位的值和偏向状态时是一样的。此时，虚拟机正是通过倒数第3为比特来区分是否为偏向锁


